<!doctype html>
<html>
<head>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <link rel="stylesheet" href="styles.css">
    <script src='Court.js'></script>
    <script src='helper.js'></script>
    <meta charset="utf-8">
    <title>Final Project</title>
</head>

<body>
    <div id="left-container"></div>
    <div id="right-container">
        <div id="top">
        </div>
        <div id="bottom">
        </div>
    </div>
    <script>
        // Test d3 was loaded
        console.log(d3);

        var WIDTH = 505;
        var HEIGHT = 475;

        //Make the Court SVG
        var courtSVG = d3.select("#top")
            .append("svg")
            .attr("id", "courtSVG")
            .attr("width", WIDTH - 5)
            .attr("height", HEIGHT);
        // Adjust the size of the SVG to make the court and append g
        courtSVG.attr('width', o.width)
            .attr('viewBox', "0 0 " + o.courtWidth + " " + o.visibleCourtLength)
            .append('g')
            .attr('class', 'shot-chart-court')

        var lineSVG = d3.select('#top')
            .append("svg")
            .attr("id", "lineSVG")
            .attr("width", WIDTH)
            .attr("height", HEIGHT);

        // Load the CSV
        d3.csv("../Resources/James Harden.csv").then(function(data, error) {
            if (error) {
                throw error;
            }
            data.forEach(function(d) {
                // Print out every line in csv to console
                // console.log(d);

                //Store the data
                d.distance = d.SHOT_DISTANCE;
                d.x = d.LOC_X;
                d.y = d.LOC_Y;
                d.made = d.SHOT_MADE_FLAG;
            });

            /*
            ==============================================
            || Below is the code to make the shot chart ||
            ==============================================*/

            // Aggregate the data, aggregate data is how many x, y points to cluster together
            var aggregateSize = 7;
            var nestedShotPos = getCombinedPos(data, aggregateSize);

            // Add the shots to the SVG
            courtSVG.select(".shot-chart-court")
                .selectAll("shots")
                .data(nestedShotPos)
                .enter()
                .append("circle")
                .attr("cx", function(d) {
                    return scaleShotsX(d.key[0], WIDTH);
                })
                .attr("cy", function(d) {
                    return scaleShotsY(d.key[1], HEIGHT);
                })
                .attr("r", .5)
                .style("fill", function(d) {
                    //console.log(d.value.shootingPercentage);
                    //console.log(fgScale(d.value.shootingPercentage));
                    return fgScale(d.value.shootingPercentage);
                })
                .style("opacity", .25)
                .on("mouseover", function(d) {
                    console.log(d.value.shootingPercentage)
                });
            // Draw the court
            drawCourt(courtSVG.select("g"));

            /*
            ==============================================
            || Below is the code to make the line chart ||
            ==============================================*/
            var nestedDist = getCombinedDist(data);

            // Add the g
            lineSVG.append("g").attr("id", "lineDots");

            // Since we need to iterate over the attempts and distances to get the d[i-1] element we can use .data(data)
            // The below creates an array of [attempts, distance] that we then iterate through and draw a line
            var lineData = [];
            nestedDist.forEach(function(d) {
                lineData.push([d.value.attempts, d.key[0]]);
            })

            lineData = lineData.sort(function(a, b) {
                return a[1] - b[1];
            });

            var index;
            for (index = 0; index < lineData.length; index++) {
                lineSVG.select("#lineDots")
                    .append("line")
                    .attr("x1", function() {
                        if (index == 0) {
                            console.log("start");
                            return d3.scaleLinear().domain([0, 60]).range([50, 550])(0);
                        } else {
                            console.log("last D = " + lineData[index - 1][1]);
                            return d3.scaleLinear().domain([0, 60]).range([50, 550])(lineData[index - 1][1]);
                        }
                    })
                    .attr("y1", function() {
                        if (index == 0) {
                            console.log("start");
                            return 400;
                        } else {
                            console.log("last A = " + lineData[index - 1][0]);
                            return d3.scaleLinear().domain([0, 1800]).range([400, 10])(lineData[index - 1][0]);
                        }
                    })
                    .attr("x2", function() {
                        console.log("curr D = " + lineData[index][1]);
                        return d3.scaleLinear().domain([0, 60]).range([50, 550])(lineData[index][1]);
                    })
                    .attr("y2", function() {
                        console.log("curr A = " + lineData[index][0]);
                        return d3.scaleLinear().domain([0, 1800]).range([400, 10])(lineData[index][0]);
                    })
                    .attr("stroke", "red")
                    .attr("stroke-width", 2);
            }
            // draw the circle data points
            lineSVG.select("#lineDots")
                .selectAll("shots")
                .data(nestedDist)
                .enter()
                .append("circle")
                .attr("cx", function(d) {
                    return d3.scaleLinear().domain([0, 60]).range([50, 550])(d.key[0]);
                })
                .attr("cy", function(d) {
                    return d3.scaleLinear().domain([0, 1800]).range([400, 10])(d.value.attempts);
                })
                .attr("r", 4)
                .attr("fill", "black")
                .on("mouseover", function(d) {
                    console.log(d.key[0] + " " + d.value.attempts);
                });
        });
    </script>
</body>
</html>
